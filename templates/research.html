<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Research Analysis</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-graph-up-arrow me-2"></i>
                Financial Data Scraper
            </a>
        </div>
    </nav>

    <main class="container my-4">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-robot text-primary me-2"></i>
                    AI Research - <span id="company-name"></span>
                </h5>
                <button id="regenerate-btn" class="btn btn-outline-secondary btn-sm d-none">
                    <i class="bi bi-arrow-clockwise me-1"></i>
                    Regenerate
                </button>
            </div>
            <div class="card-body">
                <!-- Loading -->
                <div id="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" style="width: 2.5rem; height: 2.5rem;" role="status">
                        <span class="visually-hidden">Generating...</span>
                    </div>
                    <p class="mt-3 text-muted">
                        <i class="bi bi-hourglass-split me-1"></i>
                        Generating AI analysis... This may take a few seconds.
                    </p>
                </div>
                <!-- Error -->
                <div id="error" class="alert alert-warning d-none mb-0">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    <span id="error-message"></span>
                    <button class="btn btn-sm btn-outline-warning ms-3" onclick="fetchResearch(false)">Retry</button>
                </div>
                <!-- Content -->
                <div id="content" class="d-none">
                    <div id="research-body" class="research-markdown"></div>
                    <hr>
                    <small class="text-muted">
                        <i class="bi bi-clock me-1"></i>
                        Generated: <span id="generated-at"></span>
                        <span class="ms-3">
                            <i class="bi bi-info-circle me-1"></i>
                            AI-generated analysis. Not financial advice.
                        </span>
                    </small>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const ticker = params.get('ticker');
        const companyName = params.get('company_name');

        document.getElementById('company-name').textContent = companyName || ticker || '';
        document.title = 'AI Research - ' + (companyName || ticker || '');

        const loadingEl = document.getElementById('loading');
        const errorEl = document.getElementById('error');
        const errorMsgEl = document.getElementById('error-message');
        const contentEl = document.getElementById('content');
        const bodyEl = document.getElementById('research-body');
        const generatedAtEl = document.getElementById('generated-at');
        const regenerateBtn = document.getElementById('regenerate-btn');

        regenerateBtn.addEventListener('click', function() {
            fetchResearch(true);
        });

        async function fetchResearch(refresh) {
            loadingEl.classList.remove('d-none');
            errorEl.classList.add('d-none');
            contentEl.classList.add('d-none');
            regenerateBtn.classList.add('d-none');

            try {
                let url = '/api/research/' + encodeURIComponent(ticker)
                    + '?company_name=' + encodeURIComponent(companyName);
                if (refresh) url += '&refresh=true';

                const response = await fetch(url);
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.detail || 'Failed to generate research');
                }

                const result = await response.json();

                if (typeof marked !== 'undefined') {
                    bodyEl.innerHTML = marked.parse(result.analysis);
                } else {
                    bodyEl.textContent = result.analysis;
                    bodyEl.style.whiteSpace = 'pre-wrap';
                }

                if (result.generated_at) {
                    const date = new Date(result.generated_at);
                    generatedAtEl.textContent = date.toLocaleString('en-IN', {
                        day: 'numeric', month: 'short', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                }

                loadingEl.classList.add('d-none');
                contentEl.classList.remove('d-none');
                regenerateBtn.classList.remove('d-none');

            } catch (err) {
                loadingEl.classList.add('d-none');
                errorMsgEl.textContent = err.message;
                errorEl.classList.remove('d-none');
                regenerateBtn.classList.remove('d-none');
            }
        }

        if (ticker && companyName) {
            fetchResearch(false);
        } else {
            loadingEl.classList.add('d-none');
            errorMsgEl.textContent = 'Missing company information. Please go back and try again.';
            errorEl.classList.remove('d-none');
        }
    </script>
</body>
</html>
